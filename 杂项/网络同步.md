# 网络同步

## 帧同步与状态同步

### 总结

1. 帧同步就是好比如，在操作的玩家在进行一个录像带的录制，并且还要把这个录像带同步给所有玩家，所以他的断线重连就是加速跑帧

2. 帧同步最大的优点在于，开发复杂的技能和功能时候，效率高，服务端只是转发操作指令，这点是优于状态同步

3. 帧同步没有我的概念，在开发的时候就要做到操作（逻辑层）和表现（表示层）分离，保障代码的一致。（一款好的动作游戏甚至可以做到就算没有模型也可以进行格斗，击打。据说王者荣耀就可以做到）

4. 帧同步的一个缺点就是，不适合大地图大世界的游戏。因为帧同步的逻辑是运算在客户端上的。比如千米以外有个人在盖房子，帧同步的话还需要同步他的操作指令，还原这个房子

   但是状态同步的话，只是记录状态，记录数据。状态同步可以通过AOI技术，只同步感兴趣的范围，进入其他未同步的范围时，可以通过状态还原，瞬间同步，但是帧同步是基于跑帧来还原同步的。

### 帧同步

1. 游戏逻辑的处理放在客户端，服务器端负责发放操作指令。
2. 帧同步有多种同步策略，除了接下来讲的和解（回滚），还有Lockstep和指令buffer
3. Lockstep：
   1. 以前魔兽争霸的联机模式，几个人链接局域网，一个人当主机（延迟非常的低）。
   2. Lockstep会把游戏分成一个个块，每个块会去收集玩家们的操作指令，只有在块收集完所有玩家的指令结束后，它才会向所有玩家广播操作（就很像回合制，一个回合结束后才会进行下一个回合）。这意味着它的延迟等于所有玩家中延迟最慢的那一个，就比如说以前qq对战平台的魔兽，当有一个玩家掉线时，所有人就都会卡住。~~或者打游戏卡时我们就会叫主机把后台的快播给关了。~~（其实不能怪主机）。
   3. Lockstep中会不会出现延迟导致的不一致问题？显然不会，从上面的分析可以知道，使用Lockstep的游戏是严格按照turn向前推进的，如果有人延迟比较高，其他玩家必须等待该玩家跟上之后再继续计算，不存在某个玩家领先或落后其他玩家若干个块的情况。
   4. Lockstep是非常严格的，要求每一步的的计算结果都完全一样，任何计算错误都有可能导致蝴蝶效应，产生严重的后果，因为状态不能同步的话游戏根本就没有办法进行下去，最终将崩溃退出。
4. 指令buffer
   1. 指令buffer会储存玩家的所有指令，互相直接都有编号，客户端需要按指定顺序输入帧，只有当我收到第N+1帧时，我才会去执行第N帧，如果我没收到第N帧，我就会卡住。
   2. buffer的大小影响延迟和卡顿。buffer越小，延迟越低。因为我拿到buffer后不需要延迟等待就可以立马执行。但卡顿也会越明显。~~如果连最坏的网络情况都考虑进去，buffer足够大，那么记过就跟看视频是一样的，平行的东西，看你调大条小。~~

### 状态同步

1. 游戏逻辑的处理放在服务器端，服务器处理完后，将结果下发给各个客户端，客户端上进行游戏画面的播放。

![](https://gitee.com/MeguminMO/drawing-bed/raw/master//typora/202112211910165.png)

### 同步策略

1. 慢节奏

   1. 比如斗地主，五子棋之类的游戏，在客户端进行游戏操作后，客户端会立即做出反馈（**及时反馈**），但实际上到达服务器的时间会延迟。

2. 快节奏

   1. 无冲突的。就比如qq飞车里的与自己的影子进行比赛。可能你的网络很卡，但你做的任何操作都会立即应用到表现层，就跟**单机游戏**一样。
   2. 有冲突的。比如qq飞车的正常比赛。

3. 快节奏，有冲突的

   1. 解决办法：预测，和解，插值

   2. 多人游戏时，通常会划分为表现层和逻辑层。

   3. 逻辑层和表现层都是面向数据的，将玩家的生命，位置统称为状态。影响状态变换的称为**输入**![](https://gitee.com/MeguminMO/drawing-bed/raw/master//typora/202112211909069.png)

   4. 逻辑层的本质上是一个**状态机**

   5. 逻辑层的处理过程中，有几点需要关注

      1. 无输入，不变换

      2. 无外部依赖，如系统时间，网络状态等等

      3. 结果一致性，在相同状态下一样的输入，会得到一样的结果

      4. tip：随机数的处理可以使用，伪随机数。输入同一个种子会得到同一个结果

### 预测，和解，插值

1. 预测
   1. 将玩家的输入立即应用到本地状态，无需等待服务器返
   2. 但可能存在一个问题，比如你本地从0米移动10米，到服务器存在延迟只同步给你了操作“移动到8米”，因此你会被扯回到8米。
2. 和解 或者叫回滚 或者叫Time Warp
   1. 和解公式  **预测状态 = 权威状态 + 预测输入**
   2. 一般我们认为服务器总是权威的，从服务端接收到的输入称为 **权威输入**，经权威输入计算出来的状态称为 **权威状态**。同样的，当我们发出一个输入，但尚未得到服务端的返回确认时，这个输入称为非权威输入，也叫 **预测输入**。
   3. 和解过程（状态同步）
      1. 首先，服务器是落后于客户端的
      2. 当客户端收到服务端同步来的 **权威状态**
      3. 将本地状态立即设为此权威状态
      4. 在权威状态的基础上，应用当前所有 **预测输入**
   4. 和解过程（帧同步）
      1. 收到服务端同步来的**权威输入**
      2. 将本地状态立即 **回滚** 至 **上一次的权威状态**
      3. 将权威输入应用到当前状态，得到此次的 **权威状态**。
      4. 在权威状态的基础上，应用当前所有 **预测输入**
   5. 由此可见，状态同步和帧同步只是网络传输的内容不同，但它们是完全可以相互替代的 —— 最终目的都是为了同步权威状态。![](https://gitee.com/MeguminMO/drawing-bed/raw/master//typora/202112211908022.png)
   6. 以上的预测输入，不仅是预测自己的输入，同时也预测别的客户端输入（是真正逻辑是的预测，而不是画面上的预测），对于本地的客户端来说，它自己的预测状态大概率是正确的，所有它会十分的流畅。但预测别的客户端时会出现错误，因此但本地客户端看别的客户端时会产生抖动。
3. 冲突
   1. 为什么说本地客户端的预测，大概率是正确的，而不是一定正确呢?
   2. 比如你从0米走到10米，你前5米都走的好好的。（服务器状态你在5米），你自己又走了2米，这时这个操作还没上传服务器。但你在5米的位置被人晕住了，因此你接下来的预测就失效了，你会被卡回5米的位置。（冲突）![](https://gitee.com/MeguminMO/drawing-bed/raw/master//typora/202112211909061.png)
4. 插值
   1. 前面提到了，本地客户端看别的客户端会产生抖动，其中一个解决办法就是对动画进行插值。（当然最好的办法就是预测准确）
   2. 预测+和解是解决 **自己** 的问题，发生在 **逻辑层**；插值是解决 **其它人** 的问题，发生在 **表现层** 。

### 延迟处理

1. 从上面的几个例子中，我们可以得出几个重要的结论：
   - 在无冲突时，网络延迟并 **不会** 影响操作延迟，预测+和解能实现本地 **零延迟** 的操作体验
   - 发生冲突时，本地状态立即重设到最新状态，画面跳变，只有此时玩家能明显感受到 **“卡了”**
   - **网络延迟影响的是冲突概率**：网络延迟越大，发生冲突的可能性越大
2. 延迟（同步频率）越小（越高）越好吗？或者说客户端与服务器的时间越接近越好吗（客户端领先服务器的时间）？
   1. 除了网络之外，同步频率也会影响延迟。比如服务端逻辑帧率每秒同步 10 次，那么意味着即便局域网内也可能出现 100ms 的延迟。（这里题目中的延迟指的是同步频率）
   2. 不一定，延迟小。意味着本地客户端对于其他客户端预测出错的概率会小，就算有也只会错几帧（回滚时，看其它客户端基本上不会有什么变化）。但如果你的网络不好，网络波动很大，你看别人的移动就会在不停的闪烁（如何延迟高，你会看到别人走了一段距离然后才闪烁回来）。
   3. 因此对于不同网络的用户可以采用不同的延迟策略（同步频率），网络好的延迟小一点，网络不好的延迟大一点。



### 延迟时的判定

1. 举例：在一片空地上，你拿起狙击枪瞄准一个正在移动的敌人头部。点下鼠标，一发弹道闪过 —— 你很确定，命中了！然而，由于网络延迟的存在，你看到的敌人，实际上是 200ms 以前的位置。在服务端的视角看来，你开枪的时刻敌人已经走远 —— 你打空了。那么此时，应当如何判定呢？我们分别来看看。

2. 假设我们选择以 **服务端** 的判定为准，那么你会很不爽。因为在你看来，明明打中了，敌人却没掉血，那对面肯定是开挂了。理论上，对面会很爽，因为服务端保护了他免于受伤。但事实上他没什么可开心的，因为他完全不知道服务端为他做了什么，他只会觉得 “对面真菜” 。

   那如果我们选择以 **客户端** 的判定为准呢？当然你会很爽，因为判定结果和你的预期一致，你觉得这个游戏丝滑流畅没延迟，爽爆了。理论上对面会不爽，因为从服务端视角来看，其实你没打中他。但事实上他并不知道实际上发生了什么，他只会觉得是你枪法不错，打中了他。虽然被打中了，但对于他而言，游戏体验是流畅和符合预期的，没什么不爽。（因此可以根据自己需求进行抉择）

3. tips：你也可以在客户端发送输入时带上游戏时间，由服务端根据实际延迟来决定由谁判定。比如延迟在 200ms 以内时由客户端判定，否则由服务端判定。

### 参考链接

1. https://mp.weixin.qq.com/s/G-Dc8vBODRsun20zMmYzJw
2. https://blog.csdn.net/yptianma/article/details/103268503
3. https://blog.csdn.net/qq_42672770/article/details/112599117
4. https://www.cnblogs.com/sanyejun/p/15413996.html
