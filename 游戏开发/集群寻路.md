## 集群寻路

### 寻路

​	对Agent进行路径规划，实际上要完成的任务就是让Agent从点A无碰撞地移动到点B。而路径规划的过程是层次化的，其基本框架大致如下

1. High level: dijkstra、A*等寻路算法。
2. Low level: VO, RVO, ORCA等底层避障算法。



### RVO（Reciprocal Velocity Obstacles）障碍物规避算法

![1651747557028](%E9%9B%86%E7%BE%A4%E5%AF%BB%E8%B7%AF_%E5%9B%BE%E7%89%87/1651747557028.png)

![1651747577615](%E9%9B%86%E7%BE%A4%E5%AF%BB%E8%B7%AF_%E5%9B%BE%E7%89%87/1651747577615.png)

![1651747612682](%E9%9B%86%E7%BE%A4%E5%AF%BB%E8%B7%AF_%E5%9B%BE%E7%89%87/1651747612682.png)

### ORCA

 跟RVO一样，ORCA也是基于VO的也可称之为ROV2 ，但更加实用，因为：

1. 效果上：考虑了速度的大小，使得筛选粒度更细，不像VO和RVO只考虑速度方向。
2. 效率上：求解过程基本只用到了线性规划，比较高效。不像VO和RVO有大量的非线性求解。
3. 论文： [ORCA.pdf](ORCA.pdf) 
4. 代码： [ORCA.zip](ORCA.zip) 

 RVO 虽然解决了 VO 算法出现的问题，并且在单对单的避障中几乎总是表现良好，但当智能体的数量增多时，还是会出现不符合预期的现象。 ORCA则可以解决这种现象。它可以对每个代理对象划分出一个半平面，最后对所有半平面求一个交集即可。

[参考链接1]: https://indienova.com/indie-game-development/vo-rvo-orca/

，

[参考链接2]: https://blog.csdn.net/liuerin/article/details/103610440



### Kd Tree

 kd-tree简称k维树，是一种空间划分的数据结构。常被用于高维空间中的搜索，比如范围搜索和最近邻搜索。kd-tree是二进制空间划分树的一种特殊情况 .

算法：

```cpp
Input:  无序化的点云，维度k
Output：点云对应的kd-tree
Algorithm：
1、初始化分割轴：对每个维度的数据进行方差的计算，取最大方差的维度作为分割轴，标记为r；
2、确定节点：对当前数据按分割轴维度进行检索，找到中位数数据，并将其放入到当前节点上；
3、划分双支：
    划分左支：在当前分割轴维度，所有小于中位数的值划分到左支中；
    划分右支：在当前分割轴维度，所有大于等于中位数的值划分到右支中。
4、更新分割轴：r = (r + 1) % k;
5、确定子节点：
    确定左节点：在左支的数据中进行步骤2；
    确定右节点：在右支的数据中进行步骤2；
```

### kdTree 的查找

最近邻检索

![1652068494672](%E9%9B%86%E7%BE%A4%E5%AF%BB%E8%B7%AF_%E5%9B%BE%E7%89%87/1652068494672.png)

- **一个最近邻**

一个最近邻其实很简单，我们只需要定位到对应的分支上，找到最接近的点就可以了。

举个例子：查找(2.1,3.1)的最近邻。

1. 计算当前节点(7,2)的距离，为6.23，并且暂定为(7,2)，根据当前分割轴的维度（2.1 < 7），选取左支。
2. 计算当前节点(5,4)的距离，为3.03，由于3.03 < 6.23，暂定为(5,4)，根据当前分割轴维度（3.1 < 4），选取左支。
3. 计算当前节点(2,3)的距离，为0.14，由于0.14 < 3.03，暂定为(2,3)，根据当前分割轴维度（2.1 > 2），选取右支，而右支为空，回溯上一个节点。
4. 计算(2.1,3.1)与(5,4)的分割轴{y = 4}的距离，如果0.14小于距离值，说明就是最近值。如果大于距离值，说明，还有可能存在值与(2.1,3.1)最近，需要往右支检索。

由于0.14 < 0.9，我们找到了最近邻的值为(2,3)，最近距离为0.14。

- **多个最近邻**

多个近邻其实和一个最近邻类似，不过是存储区间变为了多个，判定方法还是完全一样。

### 最后效果

![groupFindPath](%E9%9B%86%E7%BE%A4%E5%AF%BB%E8%B7%AF_%E5%9B%BE%E7%89%87/groupFindPath.gif)

以上效果还未实现动态避障（也就是ORCA）。